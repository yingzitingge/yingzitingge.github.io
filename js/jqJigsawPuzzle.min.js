/*
 * Copyright 2012 JFMDev. Licensed under MPL v2.0.
 */
jqJigsawPuzzle=new Object,jqJigsawPuzzle.pieceSizes={small:{logical:25,real:43},normal:{logical:50,real:86},big:{logical:100,real:170}},jqJigsawPuzzle.randomPieceTypes=function(e,t){for(var i=new Array,a=0;e>a;a++){i[a]=new Array;for(var r=0;t>r;r++)if((a+r)%2==0){var s=Math.floor(16*Math.random());0==a&&(s=8|s),a==e-1&&(s=2|s),0==r&&(s=4|s),r==t-1&&(s=1|s),i[a][r]=s}}for(a=0;e>a;a++)for(r=0;t>r;r++)if((a+r)%2==1){var u=0;0!=a&&(u|=(2&i[a-1][r])<<2),a!=e-1&&(u|=(8&i[a+1][r])>>2),0!=r&&(u|=(1&i[a][r-1])<<2),r!=t-1&&(u|=(4&i[a][r+1])>>2),i[a][r]=15-u}for(a=0;e>a;a++)for(r=0;t>r;r++){var n="";n+=0!=(8&i[a][r])?"1":"0",n+=0!=(4&i[a][r])?"1":"0",n+=0!=(2&i[a][r])?"1":"0",n+=0!=(1&i[a][r])?"1":"0",i[a][r]=n}return i},jqJigsawPuzzle.shufflePieces=function(e,t){var i=jQuery(e).find("div.puzzle"),a=null==t||isNaN(t.rightLimit)?0:t.rightLimit,r=null==t||isNaN(t.leftLimit)?0:t.leftLimit,s=null==t||isNaN(t.topLimit)?0:t.topLimit,u=null==t||isNaN(t.bottomLimit)?0:t.bottomLimit,n=i.width()+r+a,l=i.height()+s+u;jQuery(e).find("div.piece").each(function(){var e=jQuery(this).width(),t=jQuery(this).height();jQuery(this).css("left",Math.floor(Math.random()*(n-e))-r),jQuery(this).css("top",Math.floor(Math.random()*(l-t))-s)})},jqJigsawPuzzle.createPuzzleFromURL=function(e,t,i){var a="img_"+(new Date).getTime();jQuery(e).append('<img src="'+t+'" id="'+a+'" alt=""/>'),jqJigsawPuzzle.createPuzzleFromImage("#"+a,i)},jqJigsawPuzzle.createPuzzleFromImage=function(e,t){if(jQuery(e).size()>0)if(jQuery(e).width()>0&&jQuery(e).height()>0)jqJigsawPuzzle.imageToPuzzle(e,t);else{var i=!1;jQuery(e).load(function(){i||(i=!0,jqJigsawPuzzle.imageToPuzzle(e,t))}),jQuery(e).width()>0&&jQuery(e).height()>0&&(i=!0,jqJigsawPuzzle.imageToPuzzle(e,t))}},jqJigsawPuzzle.imageToPuzzle=function(e,t){var i=jQuery(e);i.size()>1&&(i=i.find(":first"));var a=null!=t&&null!=t.piecesSize?t.piecesSize:"normal";"normal"!=a&&"small"!=a&&"big"!=a&&(a="normal");var r=null==t||isNaN(t.borderWidth)?5:parseInt(t.borderWidth,10),s="puzzle_"+(new Date).getTime(),u=i.width(),n=i.height(),l=i.position().left,o=i.position().top,d=i.attr("src"),z='<div class="jigsaw" id="'+s+'" style="left:'+(l-r)+"px; top:"+(o-r)+"px; width:"+u+"px; min-height:"+n+"px; border-width:"+r+'px;"><div class="puzzle" style="width:'+u+"px; height:"+n+"px; background-image:url('"+d+'\');"></div><div class="menu" style="width:'+u+'px;"><table class="menu"><tr><td><a href="#" class="button" id="'+s+'_shuffle" title="Shuffle">Shuffle</a></td><td>Movements: <span class="movement_compter" id="'+s+'_movements"></span></td><td>Time: <span class="time_compter" id="'+s+'_time"></span></td></tr></table></div></div>';jQuery("body").append(z);var p=jQuery("#"+s),m=jqJigsawPuzzle.pieceSizes[a].logical,c=jqJigsawPuzzle.pieceSizes[a].real,g=(c-m)/2,f=parseInt(u/m);u%m!=0&&f++;var h=parseInt(n/m);n%m!=0&&h++,p.data("pieces-number",f*h),p.data("pieces-located",0);var j=jqJigsawPuzzle.randomPieceTypes(h,f);p.data("last-z-index",h*f),p.find("div.menu").css("z-index",h*f);for(var w=0;h>w;w++)for(var v=0;f>v;v++){var y=-g+v*m,P=-g+w*m,q=g-v*m,J=g-w*m,Q=s+"_piece_"+w+"x"+v,x="piece_"+j[w][v];z='<div id="'+Q+'" class="piece '+a+" "+x+'" data-posX="'+y+'" data-posY="'+P+'" style="background-image: url(\''+d+"');background-position: "+q+"px "+J+"px;left: "+y+"px; top: "+P+"px; width: "+c+"px; height: "+c+'px;"></div>',p.append(z),jQuery("#"+Q).css("z-index",h*f-1),jQuery("#"+Q).draggable({start:function(e,t){var i=parseInt(jQuery(this).attr("data-posX"),10),a=parseInt(jQuery(this).attr("data-posY"),10);if(i==t.position.left&&a==t.position.top)return!1;jqJigsawPuzzle.startTimerCounter(p);var r=parseInt(p.data("last-z-index"),10);return jQuery(this).css("z-index",r),p.data("last-z-index",r+1),!0},stop:function(e,t){var i=parseInt(jQuery(this).attr("data-posX"),10),a=parseInt(jQuery(this).attr("data-posY"),10),r=t.position.left-i,s=t.position.top-a;if(r>-g&&g>r&&s>-g&&g>s){jQuery(this).css("left",i),jQuery(this).css("top",a),jQuery(this).css("z-index",h*f-2),null!=jqJigsawPuzzle.pieceSound&&jqJigsawPuzzle.pieceSound.play(),p.addClass("highlight"),setTimeout(function(){p.removeClass("highlight")},250);var u=parseInt(p.data("pieces-located"),10);p.data("pieces-located",u+1),u+1>=parseInt(p.data("pieces-number"),10)&&(p.addClass("resolved"),jqJigsawPuzzle.stopTimerCounter(p),null!=jqJigsawPuzzle.finishSound&&jqJigsawPuzzle.finishSound.play())}jqJigsawPuzzle.increaseMovementCounter(p)}})}jqJigsawPuzzle.shufflePieces(p,null!=t?t.shuffle:null),jqJigsawPuzzle.resetCounters(p),jQuery("#"+s+"_shuffle").click(function(){p.data("pieces-located",0),p.removeClass("highlight"),p.removeClass("resolved"),jqJigsawPuzzle.shufflePieces(p,null!=t?t.shuffle:null),jqJigsawPuzzle.resetCounters(p)})},jqJigsawPuzzle.resetCounters=function(e){jqJigsawPuzzle.stopTimerCounter(e),jqJigsawPuzzle.setTimerCounter(e,0),jQuery(e).find(".movement_compter").html("0")},jqJigsawPuzzle.increaseMovementCounter=function(e){var t=parseInt(jQuery(e).find(".movement_compter").html(),10);jQuery(e).find(".movement_compter").html(t+1+"")},jqJigsawPuzzle.startTimerCounter=function(e){if("running"!=jQuery(e).data("timer-status")){jQuery(e).data("timer-status","running"),jQuery(e).data("timer-value",(new Date).getTime());var t=setInterval(function(){jqJigsawPuzzle.refreshTimerCounter(e)},1e3);jQuery(e).data("timer-interval",t)}},jqJigsawPuzzle.stopTimerCounter=function(e){"stopped"!=jQuery(e).data("timer-status")&&(jQuery(e).data("timer-status","stopped"),clearInterval(jQuery(e).data("timer-interval")))},jqJigsawPuzzle.refreshTimerCounter=function(e){var t=(new Date).getTime();jqJigsawPuzzle.setTimerCounter(e,t-jQuery(e).data("timer-value"))},jqJigsawPuzzle.setTimerCounter=function(e,t){t=t>0?t/1e3:0;var i=parseInt(t%60,10),a=parseInt(t/60%60,10),r=parseInt(t/3600,10);10>i&&(i="0"+i),10>a&&(a="0"+a),10>r&&(r="0"+r),jQuery(e).find(".time_compter").html(r+":"+a+":"+i)},jqJigsawPuzzle.pieceSound=null,jqJigsawPuzzle.finishSound=null,soundManager.setup({url:"swf/",flashVersion:9,useFlashBlock:!1,onready:function(){jqJigsawPuzzle.pieceSound=soundManager.createSound({id:"piece",url:"mp3/tom1.mp3"}),jqJigsawPuzzle.finishSound=soundManager.createSound({id:"finish",url:"mp3/large_crowd_applause.mp3"})},ontimeout:function(){}});